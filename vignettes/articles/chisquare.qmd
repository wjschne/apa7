---
title: "Contingency Tables"
vignette: >
  %\VignetteIndexEntry{Contingency Tables}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
knitr:
  opts_chunk:
    collapse: true
    comment: '#>'
---

```{r}
#| label: setup
#| include: false
library(apa7)
library(dplyr)
library(tidyr)
library(flextable)
library(ftExtra)
```

```{r}
#| label: setup
```

# Data

```{r}
#| label: data
d <- mtcars |>
  select(Gears = gear, Transmission = am) |>
  mutate(Transmission = factor(Transmission, labels = c("Automatic", "Manual")))
```

# The `apa_chisq` contingency table function

The default output of the `apa_chisq` function is a contingency table with a chi-square test of independence in the table note. The output is a flextable, which can be modified with flextable commands.

```{r}
#| label: apachisq
apa_chisq(d)
```

# Styling Options

The table can be styled in many ways:

```{r}
#| label: options
apa_chisq(
  d,
  font_size = 16,
  line_spacing = 3,
  text_color = "darkred",
  border_width = 2,
  border_color = "gray",
  font_family = "Arial"
)
```

```{r}
#| label: customization
# No note
apa_chisq(d, note = NA)
# Custom note
apa_chisq(
  d,
  note = "This is a *custom* note written in **markdown** $x > \\omega$."
)

```

# What if I want something completely different?

There are a lot of options out there. The flextable package has the `proc_freq` function, which has the ability to include row, column, and total percentages in the table.

```{r}
#| label: procfreq
mtcars %>%
  proc_freq(row = "gear", col = "vs") %>%
  theme_apa()
```

These can be turned off selectively:

```{r}
#| label: procfreqoptions
mtcars %>%
  proc_freq(
    row = "gear",
    col = "vs",
    include.row_percent = FALSE,
    include.column_percent = FALSE,
    include.table_percent = FALSE
  ) %>%
  apa_style(table_width = .5)
```

The flextable package's `tabulator` function has considerable power in creating a wide variety of descriptive tables. In general, the `tabulator` function requires that you calculate the statistics first, and then you specify where they should go.

Here I calculate the means, standard deviations, and sample sizes within each cell of a contingency table.

```{r}
warpbreaks |>
  summarise(
    Mean = mean(breaks, na.rm = TRUE),
    stdev = sd(breaks, na.rm = TRUE),
    sample_size = sum(!is.na(breaks)),
    .by = c(wool, tension)
  ) %>%
  rename(Wool = wool) |>
  mutate(
    tension = factor(
      tension,
      labels = paste(c("Low", "Medium", "High"), "Tension")
    )) |>
  flextable::tabulator(
    rows = "Wool",
    columns = "tension",
    M = as_paragraph(Mean),
    SD = as_paragraph(stdev),
    n = as_paragraph(sample_size)
  ) |>
  flextable::as_flextable() |>
  italic(i = 2, part = "header") |>
  align(j = 1, align = "center") |> 
  theme_apa()
```

# Processing Data Yourself

What if you want it to look a little different? Unfortunately, you might have to do some of the heavy lifting yourself. The `tidyr::pivot_wider` function can save a lot of time, if you know how to use the `names_glue` argument to get the column names in the right order and `names_vary` argument to get the columns in the right order.

A subtle difference in this version of the table is that the columns are decimal aligned, which is evident in the standard deviation column.

Also, whereas previously the Wool column header was middle aligned, it is now top aligned, which is consistent with comparable examples in the *APA Style Manual*. I am not sure if this is a real rule in APA style, and I actually prefer middle alignment for situations like this.

```{r warpbreaks}
warpbreaks %>%
  summarise(
    M = mean(breaks, na.rm = TRUE),
    SD = sd(breaks, na.rm = TRUE),
    n = sum(!is.na(breaks)),
    .by = c(wool, tension)
  ) %>%
  rename(Wool = wool) %>%
  mutate(
    tension = factor(
      tension,
      levels = c("L", "M", "H"),
      labels = paste(c("Low", "Medium", "High"), "Tension")
    )
  ) |>
  pivot_wider(
    values_from = c(M, SD, n),
    names_from = tension,
    names_glue = "{tension}_{.value}",
    names_vary = "slowest"
  ) |>
  add_break_columns(ends_with("_n"), omit_last = TRUE) |>
  apa_flextable(column_formats = column_formats(accuracy = .1)) |>
  align(j = 1, align = "center") 
```



